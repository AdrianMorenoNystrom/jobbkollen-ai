<div class="settings-page">
  <app-page-header [title]="'settings.title' | t" [subtitle]="'settings.subtitle' | t">
    <div page-actions class="settings__actions">
      <button mat-stroked-button type="button" (click)="signOut()" [disabled]="isSaving || isLoading">
        {{ 'menu.signOut' | t }}
      </button>
      <button
        mat-flat-button
        color="primary"
        type="button"
        class="settings__button"
        [disabled]="isSaving || isLoading"
        (click)="save()"
      >
        @if (isSaving) {
          <mat-progress-spinner class="settings__spinner" diameter="16" mode="indeterminate"></mat-progress-spinner>
        }
        <span>{{ 'common.save' | t }}</span>
      </button>
    </div>
  </app-page-header>

  <form class="settings__grid" [formGroup]="form">
    <mat-card class="settings__section settings__section--profile">
      <mat-card-header>
        <mat-card-title>{{ 'settings.section.profile' | t }}</mat-card-title>
      </mat-card-header>
      <mat-card-content class="settings__section-content">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'onboarding.firstNameLabel' | t }}</mat-label>
          <input matInput formControlName="first_name" autocomplete="given-name" />
          @if (form.controls.first_name.touched && form.controls.first_name.invalid) {
            <mat-error>{{ 'onboarding.firstNameError' | t }}</mat-error>
          }
        </mat-form-field>

        <div class="settings__palette">
          <div class="settings__palette-header">
            <div>
              <h3>{{ 'onboarding.avatarTitle' | t }}</h3>
              <p>{{ 'onboarding.avatarSubtitle' | t }}</p>
            </div>
          </div>

          <mat-button-toggle-group
            class="settings__palette-grid"
            formControlName="avatar_color"
            [attr.aria-label]="'onboarding.avatarAria' | t"
            disableRipple
            [hideSingleSelectionIndicator]="true"
          >
            @for (color of colors; track color.id) {
              <mat-button-toggle
                [value]="color.id"
                class="palette__option"
                [attr.aria-label]="('onboarding.colorPrefix' | t) + ' ' + (color.labelKey | t)"
              >
                <app-avatar
                  class="palette__avatar"
                  [name]="form.controls.first_name.value"
                  [color]="color.id"
                ></app-avatar>
              </mat-button-toggle>
            }
          </mat-button-toggle-group>

          @if (form.controls.avatar_color.touched && form.controls.avatar_color.invalid) {
            <p class="settings__error">{{ 'onboarding.avatarError' | t }}</p>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="settings__section">
      <mat-card-header>
        <mat-card-title>{{ 'settings.section.language' | t }}</mat-card-title>
      </mat-card-header>
      <mat-card-content class="settings__section-content">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'settings.languageLabel' | t }}</mat-label>
          <mat-select
            formControlName="preferred_language"
            (selectionChange)="onLanguageChange($event.value)"
          >
            @for (language of languages; track language.value) {
              <mat-option [value]="language.value">{{ language.labelKey | t }}</mat-option>
            }
          </mat-select>
          <mat-hint>{{ 'settings.languageHint' | t }}</mat-hint>
          @if (form.controls.preferred_language.touched && form.controls.preferred_language.invalid) {
            <mat-error>{{ 'settings.languageError' | t }}</mat-error>
          }
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card class="settings__section">
      <mat-card-header>
        <mat-card-title>{{ 'settings.section.reminders' | t }}</mat-card-title>
      </mat-card-header>
      <mat-card-content class="settings__section-content">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'settings.reminderEmailLabel' | t }}</mat-label>
          <input matInput type="email" formControlName="reminder_email" autocomplete="email" />
          <mat-hint>{{ 'settings.reminderEmailHint' | t }}</mat-hint>
          @if (form.controls.reminder_email.touched && form.controls.reminder_email.invalid) {
            <mat-error>{{ 'settings.reminderEmailError' | t }}</mat-error>
          }
        </mat-form-field>

        <div class="settings__toggle">
          <mat-slide-toggle formControlName="reminders_enabled">
            {{ 'settings.remindersEnabledLabel' | t }}
          </mat-slide-toggle>
          <p class="settings__hint">{{ 'settings.remindersEnabledHint' | t }}</p>
        </div>
      </mat-card-content>
    </mat-card>

  </form>

  <div class="settings__status" aria-live="polite"></div>
</div>
